<!doctype html>
<meta charset="utf8">
<link href="ecmarkup.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/github.min.css">
<script src="ecmarkup.js"></script>
<pre class=metadata>
title: ECMAScript Realms Spec Proposal
stage: 0
contributors: Dave Herman, Caridy Patiño, Mark Miller
status: draft
copyright: false
location: https://rawgit.com/tc39/proposal-realms/master/index.html
</pre>

<emu-table id="table-1" caption="Well-known Intrinsic Objects">
    <table>
        <tbody>
            <tr>
                <th>Intrinsic Name</th>
                <th>Global Name</th>
                <th>ECMAScript Language Association</th>
            </tr>
            <tr>
                <td>%Realm%</td>
                <td><code>Realm</code></td>
                <td>…</td>
            </tr>
            <tr>
                <td>%RealmPrototype%</td>
                <td><code>Realm.prototype</code></td>
                <td>…</td>
            </tr>
        </tbody>
    </table>
</emu-table>

<emu-clause id="sec-realm-objects">
  <h1>Realm Objects</h1>
  <emu-clause id="sec-realm-abstract-operations">
    <h1>Realm Abstract Operations</h1>

    <emu-clause id="sec-perform-realm-script-evaluation" aoid="PerformRealmScriptEvaluation">
      <h1>PerformRealmScriptEvaluation ( _sourceText_, _realm_ )</h1>
      <emu-alg>
      1. Assert: _sourceText_ is an ECMAScript source text (see clause <emu-xref href="#sec-ecmascript-language-source-code"></emu-xref>).
      1. Assert: _realm_ is a Realm Record.
      1. Let _hostDefined_ be _realm_.[[HostDefined]].
      1. Let _s_ be ParseScript(_sourceText_, _realm_, _hostDefined_).
      1. If _s_ is a List of errors, then
        1. Perform HostReportErrors(_s_).
        1. Return NormalCompletion(*undefined*).
      1. Return ? ScriptEvaluation(_s_).
      </emu-alg>
    </emu-clause>

    <emu-clause id="sec-perform-realm-module-evaluation" aoid="PerformRealmModuleEvaluation">
      <h1>PerformRealmModuleEvaluation ( _sourceText_, _realm_ )</h1>
      <emu-alg>
      1. Assert: _sourceText_ is an ECMAScript source text (see clause <emu-xref href="#sec-ecmascript-language-source-code"></emu-xref>).
      1. Assert: _realm_ is a Realm Record.
      1. Let _hostDefined_ be _realm_.[[HostDefined]].
      1. Let _m_ be ParseModule(_sourceText_, _realm_, _hostDefined_).
      1. If _m_ is a List of errors, then
        1. Perform HostReportErrors(_m_).
        1. Return NormalCompletion(*undefined*).
      1. Perform ? _m_.Link().
      1. Assert: All dependencies of _m_ have been transitively resolved and _m_ is ready for evaluation.
      1. Perform ? _m_.Evaluate().
      1. Return GetModuleNamespace(_m_).
      </emu-alg>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-the-realm-constructor">
    <h1>The Realm Constructor</h1>
    <p>The Realm constructor:</p>
    <ul>
      <li>is the intrinsic object <dfn>%Realm%</dfn>.</li>
      <li>is the initial value of the *"Realm"* property of the global object.</li>
      <li>is not intended to be called as a function and will throw an exception when called in that manner.</li>
      <li>creates and initializes a new Realm object when called as a constructor.</li>
      <li>is designed to be subclassable. It may be used as the value in an `extends` clause of a class definition. Subclass constructors that intend to inherit the specified `Realm` behaviour must include a `super` call to the `Realm` constructor to create and initialize the subclass instance with the internal state necessary to support the `Realm.prototype` built-in methods.</li>
    </ul>

    <emu-clause id="sec-realm">
      <h1>Realm ()</h1>
      <p>When the `Realm` function is called with no arguments, the following steps are taken:</p>
      <emu-alg>
        1. If NewTarget is *undefined*, throw a *TypeError* exception.
        1. Let _O_ be ? OrdinaryCreateFromConstructor(NewTarget, "%RealmPrototype%", « [[Realm]] »).
        1. Let _realmRec_ be CreateRealm().
        1. Set _O_.[[Realm]] to _realmRec_.
        1. Perform ? SetRealmGlobalObject(_realmRec_, *undefined*, *undefined*).
        1. Perform ? SetDefaultGlobalBindings(_O_.[[Realm]]).
        1. Return _O_.
      </emu-alg>
    </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-the-realm-constructor">
      <h1>Properties of the Realm Constructor</h1>

      The value of the [[Prototype]] internal slot of the *Realm* constructor is the intrinsic object %FunctionPrototype%.

  </emu-clause>

  <emu-clause id="sec-properties-of-the-realm-prototype-object">
      <h1>Properties of the Realm Prototype Object</h1>

      <emu-clause id="sec-realm.prototype.eval">
          <h1>Realm.prototype.evaluate ( _sourceText_, _options_ )</h1>

          Synchronously execute a top-level script or module. The _sourceText_ is interpreted as a SourceScript or SourceModule and evaluated with this bound to the realm's global object.

          <emu-alg>
          1. Let _O_ be *this* value.
          1. Perform ? RequireInternalSlot(_O_, [[Realm]]).
          1. Let _realm_ be _O_.[[Realm]].
          1. Let _sourceTextString_ be ? ToString(_sourceText_).
          1. Let _sourceType_ be *undefined*.
          1. If _options_ is not *undefined*, then
            1. Let _options_ be ? ToObject(_options_).
            1. Let _sourceType_ be ? Get(_options_, *"type"*).
          1. If _sourceType_ is *"module"*, then
            1. Return ? PerformRealmModuleEvaluation(_sourceText_, _realm_).
          1. Else if _sourceType_ is *"script"*, then
            1. Return ? PerformRealmScriptEvaluation(_sourceText_, _realm_).
          1. Else
            1. Throw a RangeError exception.
          </emu-alg>

          <emu-note>
              Extensible web: This is the dynamic equivalent of a &lt;script&gt; in HTML.
          </emu-note>
      </emu-clause>

      <emu-clause id="sec-realm.prototype.globalthis">
          <h1>get Realm.prototype.globalThis</h1>

          Realm.prototype.globalThis is an accessor property whose set accessor function is *undefined*. Its get accessor function performs the following steps:

          <emu-alg>
          1. Let _O_ be *this* value.
          1. Perform ? RequireInternalSlot(_O_, [[Realm]]).
          1. Return _O_.[[Realm]].[[GlobalEnv]].[[GlobalThisValue]].
          </emu-alg>
      </emu-clause>

      <emu-clause id="sec-realm.prototype-@@tostringtag">
          <h1>Realm.prototype [ @@toStringTag ]</h1>

          The initial value of the @@toStringTag property is the String value "Realm".

          This property has the attributes { [[Writable]]: false, [[Enumerable]]: false, [[Configurable]]: true }.
      </emu-clause>
  </emu-clause>

  <emu-clause id="sec-properties-of-realm-instances">
      <h1>Properties of Realm Instances</h1>

      Realm instances are ordinary objects that inherit properties from the Realm prototype object (the intrinsic, %RealmPrototype%). Realm instances are initially created with the internal slots described in <emu-xref href="#table-3"></emu-xref>.

      <emu-table id="table-3" caption="Internal Slots of Realm Instances">
          <table>
              <tbody>
                  <tr>
                      <th>Internal Slot</th>
                      <th>Type</th>
                      <th>Description</th>
                  </tr>
                  <tr>
                      <td>[[Realm]]</td>
                      <td>Realm Record</td>
                      <td>The Realm Record for the initial execution context.</td>
                  </tr>
              </tbody>
          </table>
      </emu-table>

  </emu-clause>

</emu-clause>
